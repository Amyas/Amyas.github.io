# 15.Watch 实现

```js
// vue.js
function Vue(options) {
  const vm = this;
  const options = vm.$options;

  if (options.watch) {
    initWatch(vm, options.watch);
  }
}

Vue.prototype.$watch = function (key, handler, options = {}) {
  options.user = true;
  new Watcher(this, key, handler, options);
};

function initWatch(vm, watch) {
  for (let key in watch) {
    let handler = watch[key];
    if (Array.isArray(handler)) {
      for (let i = 0; i < handler.length; i++) {
        createWatcher(vm, key, handler[i]);
      }
    } else {
      createWatcher(vm, key, handler);
    }
  }
}

function createWatcher(vm, key, handler) {
  return vm.$watch(key, handler);
}
```

```js
// watcher.js
let watcherId = 0;
class Watcher {
  constructor(vm, expOrFn, callback, options) {
    this.vm = vm;
    this.expOrFn = expOrFn;
    this.callback = callback;
    this.options = options;
    this.id = watcherId++;
    this.user = !!options.user;

    if (typeof expOrfn === "string") {
      this.getter = function () {
        let path = expOrfn.split(".");
        let obj = vm;
        for (let i = 0; i < path.length; i++) {
          obj = obj[path[i]];
        }
      };
    } else {
      this.getter = expOrfn;
    }
  }

  get() {
    pushTarget(this);
    const value = this.getter();
    popTarget();

    return value;
  }

  ...

  run(){
    const newValue = this.get()
    const oldValue = this.value

    this.value = newValue

    if(this.user) {
      this.callback.call(this.vm, newValue, oldValue)
    }
  }
}
```
