# 9、虚拟dom生成原理

``` js
// src/compiler/index.js
...
export function compileToFunction(template) }{
  let root = parseHTML(template)

  let code = generate(root)

  let render = new Function(`with(this){return ${code}}`)

  return render
}
```

``` js
// src/init.js
import { mountComponent } from './lifecycle'

...
Vue.prototype.$mount = function(el) {
  ...
  mountComponent(vm, el) // 组建挂在
}
```

``` js
// src/lifecycle.js
export function lifecycleMixin(Vue) {
  Vue.prototype._update = function(vnode) {
    console.log(vnode)
  }
}

export function mountComponent(vm, el) {
  // 更新函数，数据变化后，再次调用此函数
  let updateComponent = () => {
    // 调用render函数，生成虚拟dom
    vm._update(vm._render()) // 后续更新可以调用updateComponent

    // 用虚拟dom生成真是dom
  }

  updateComponent()
}
```

``` js
// src/render.js
import {createElement,createTextElement} from './vdom/index'

export function renderMixin(Vue){
  Vue.prototype._c = function(){ // createElement
    return createElement(this, ...arguments)
  }
  Vue.prototype._v = function(text){ // createTextElement
    return createTextElement(this, text)
  }
  Vue.prototype._s = function(val){ // stringify
    if(typeof val === 'object') {
      return JSON.stringify(val)
    }
    return val
  }
  Vue.prototype._render = function(){
    const vm = this
    let render = vm.$options.render // compileToFunction执行结果

    let vnode = render.call(vm)
    return vnode
  }
}
```

``` js
// src/vdom/index.js

export function createElement(vm, tag, data = {}, ...children){
  return vnode(vm,tag,data,data.key,children,undefined)
}
export function createTextElement(vm, text){
  return vnode(vm,undefined,undefined,undefined,undefined,text)
}
function vnode(vm, tag,data,key,children,text) {
  return {
    vm,
    tag,
    data,
    key,
    children,
    text
  }
}
```

``` js
// src/index.js
import {initMixin} from './init'
import {lifecycleMixin} from './lifecycle'
import {renderMixin} from './render'

function Vue(options) {
  this._init(options)
}

initMixin(Vue)
renderMixin(Vue) // _render
lifecycleMixin(Vue) // _update

export default Vue
```